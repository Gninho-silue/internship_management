<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- ================================= -->
        <!-- VUES LISTE (TREE) -->
        <!-- ================================= -->

        <!-- Enhanced Internship list view -->
        <record id="view_internship_stage_tree" model="ir.ui.view">
            <field name="name">internship.stage.tree</field>
            <field name="model">internship.stage</field>
            <field name="arch" type="xml">
                <tree string="Internships"
                      decoration-info="state=='draft'"
                      decoration-warning="state=='submitted'"
                      decoration-success="state=='approved'"
                      decoration-primary="state=='in_progress'"
                      decoration-danger="state=='cancelled'"
                      create="true"
                      multi_edit="1">

                    <!-- Reference and Name -->
                    <field name="reference" readonly="1"/>
                    <field name="name"/>

                    <!-- Type and Status -->
                    <field name="stage_type" widget="badge"
                           decoration-info="stage_type=='pfe'"
                           decoration-success="stage_type=='summer'"
                           decoration-warning="stage_type=='academic'"/>
                    <field name="state" widget="badge"
                           decoration-info="state=='draft'"
                           decoration-warning="state=='submitted'"
                           decoration-success="state=='approved'"
                           decoration-primary="state=='in_progress'"
                           decoration-danger="state=='cancelled'"/>

                    <!-- Participants -->
                    <field name="student_id"/>
                    <field name="supervisor_id"/>
                    <field name="company_id"/>

                    <!-- Dates and Duration -->
                    <field name="start_date"/>
                    <field name="end_date"/>
                    <field name="duration" string="Duration (days)"/>

                    <!-- Progress and Grades -->
                    <field name="progress" widget="progressbar"/>
                    <field name="grade" widget="numeric"/>

                    <!-- Defense Information -->
                    <field name="defense_status" widget="badge"
                           decoration-info="defense_status=='scheduled'"
                           decoration-warning="defense_status=='in_progress'"
                           decoration-success="defense_status=='completed'"
                           decoration-danger="defense_status=='cancelled'"/>
                    <field name="defense_date"/>

                    <!-- Document Status -->
                    <field name="convention_generated" widget="boolean_toggle"/>
                    <field name="attestation_generated" widget="boolean_toggle"/>

                    <!-- Creation Info -->
                    <field name="create_date"/>
                    <field name="write_date"/>
                </tree>
            </field>
        </record>

        <!-- ================================= -->
        <!-- VUES KANBAN -->
        <!-- ================================= -->

        <!-- Internship Kanban View -->
        <record id="view_internship_stage_kanban" model="ir.ui.view">
            <field name="name">internship.stage.kanban</field>
            <field name="model">internship.stage</field>
            <field name="arch" type="xml">
                <kanban default_group_by="state" class="o_kanban_small_column">
                    <field name="id"/>
                    <field name="name"/>
                    <field name="reference"/>
                    <field name="student_id"/>
                    <field name="supervisor_id"/>
                    <field name="state"/>
                    <field name="progress"/>
                    <field name="grade"/>
                    <field name="stage_type"/>
                    <field name="start_date"/>
                    <field name="end_date"/>
                    <field name="defense_date"/>
                    <field name="activity_ids"/>
                    <field name="activity_state"/>
                    <progressbar field="activity_state" colors='{"planned": "success", "today": "warning", "overdue": "danger"}'/>
                    <templates>
                        <t t-name="kanban-box">
                            <div t-attf-class="#{kanban_color(record.state.raw_value)} oe_kanban_global_click">
                                <div class="o_kanban_record_top">
                                    <div class="o_kanban_record_headings">
                                        <strong class="o_kanban_record_title">
                                            <field name="name"/>
                                        </strong>
                                    </div>
                                    <div class="o_kanban_manage_button_section">
                                        <a class="o_kanban_manage_toggle_button" href="#">
                                            <i class="fa fa-ellipsis-v" role="img" aria-label="Manage" title="Manage"/>
                                        </a>
                                    </div>
                                </div>
                                <div class="o_kanban_record_body">
                                    <div class="row">
                                        <div class="col-6">
                                            <span><field name="reference"/></span>
                                        </div>
                                        <div class="col-6">
                                            <span class="badge badge-pill" t-attf-style="background-color: #{record.stage_type.raw_value == 'pfe' ? '#875A7B' : record.stage_type.raw_value == 'summer' ? '#28a745' : '#ffc107'};">
                                                <field name="stage_type"/>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-12">
                                            <i class="fa fa-user" title="Student"/> <field name="student_id"/>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-12">
                                            <i class="fa fa-user-tie" title="Supervisor"/> <field name="supervisor_id"/>
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-6">
                                            <i class="fa fa-calendar" title="Start Date"/> <field name="start_date"/>
                                        </div>
                                        <div class="col-6">
                                            <i class="fa fa-calendar-check" title="End Date"/> <field name="end_date"/>
                                        </div>
                                    </div>
                                    <div class="row mt-2" t-if="record.progress.raw_value > 0">
                                        <div class="col-12">
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar" role="progressbar"
                                                     t-attf-style="width: #{record.progress.value}%"
                                                     t-attf-aria-valuenow="#{record.progress.value}"
                                                     aria-valuemin="0" aria-valuemax="100">
                                                    <t t-esc="record.progress.value"/>%
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="o_kanban_record_bottom">
                                    <div class="oe_kanban_bottom_left">
                                        <field name="activity_ids" widget="kanban_activity"/>
                                    </div>
                                    <div class="oe_kanban_bottom_right">
                                        <field name="grade" widget="numeric" t-if="record.grade.raw_value > 0"/>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </templates>
                </kanban>
            </field>
        </record>

        <!-- ================================= -->
        <!-- VUE RECHERCHE (SEARCH) -->
        <!-- ================================= -->

        <!-- Enhanced Search View -->
        <record id="view_internship_stage_search" model="ir.ui.view">
            <field name="name">internship.stage.search</field>
            <field name="model">internship.stage</field>
            <field name="arch" type="xml">
                <search string="Search Internships">
                    <!-- Search Fields -->
                    <field name="name"/>
                    <field name="reference"/>
                    <field name="student_id"/>
                    <field name="supervisor_id"/>
                    <field name="company_id"/>

                    <!-- Filters -->
                    <filter string="My Internships" name="my_internships"
                            domain="[('student_id.user_id', '=', uid)]"/>
                    <filter string="Internships to Supervise" name="to_supervise"
                            domain="[('supervisor_id.user_id', '=', uid)]"/>
                    <filter string="Company Internships" name="company_internships"
                            domain="[('company_id', '!=', False)]"/>

                    <!-- Status Filters -->
                    <separator/>
                    <filter string="Draft" name="draft" domain="[('state', '=', 'draft')]"/>
                    <filter string="Submitted" name="submitted" domain="[('state', '=', 'submitted')]"/>
                    <filter string="Approved" name="approved" domain="[('state', '=', 'approved')]"/>
                    <filter string="In Progress" name="in_progress" domain="[('state', '=', 'in_progress')]"/>
                    <filter string="Completed" name="completed" domain="[('state', '=', 'completed')]"/>
                    <filter string="Evaluated" name="evaluated" domain="[('state', '=', 'evaluated')]"/>
                    <filter string="Cancelled" name="cancelled" domain="[('state', '=', 'cancelled')]"/>

                    <!-- Type Filters -->
                    <separator/>
                    <filter string="PFE" name="pfe" domain="[('stage_type', '=', 'pfe')]"/>
                    <filter string="Summer Internship" name="summer" domain="[('stage_type', '=', 'summer')]"/>
                    <filter string="Academic Internship" name="academic" domain="[('stage_type', '=', 'academic')]"/>

                    <!-- Date Filters -->
                    <separator/>
                    <filter string="Current Month" name="current_month"
                            domain="[('start_date', '&gt;=', context_today().replace(day=1))]"/>
                    <filter string="This Year" name="this_year"
                            domain="[('start_date', '&gt;=', context_today().replace(month=1, day=1))]"/>

                    <!-- Group By -->
                    <group expand="0" string="Group By">
                        <filter string="State" name="group_state" context="{'group_by': 'state'}"/>
                        <filter string="Type" name="group_type" context="{'group_by': 'stage_type'}"/>
                        <filter string="Student" name="group_student" context="{'group_by': 'student_id'}"/>
                        <filter string="Supervisor" name="group_supervisor" context="{'group_by': 'supervisor_id'}"/>
                        <filter string="Company" name="group_company" context="{'group_by': 'company_id'}"/>
                        <filter string="Start Date" name="group_start_date" context="{'group_by': 'start_date:month'}"/>
                        <filter string="End Date" name="group_end_date" context="{'group_by': 'end_date:month'}"/>
                        <filter string="Defense Status" name="group_defense_status" context="{'group_by': 'defense_status'}"/>
                    </group>
                </search>
            </field>
        </record>

        <!-- ================================= -->
        <!-- VUES FORMULAIRE (FORM) -->
        <!-- ================================= -->

        <!-- Internship form view -->
        <record id="view_internship_stage_form" model="ir.ui.view">
            <field name="name">internship.stage.form</field>
            <field name="model">internship.stage</field>
            <field name="arch" type="xml">
                <form string="Internship">
                    <header>
                        <!-- Status Badge -->
                        <field name="state" widget="statusbar" statusbar_visible="draft,submitted,approved,in_progress,completed,evaluated"/>

                        <!-- Action Buttons -->
                        <button name="action_submit" string="Submit for Approval" type="object"
                                class="oe_highlight"
                                help="Submit internship for supervisor approval"
                                invisible="state != 'draft'"/>

                        <button name="action_approve" string="Approve Internship" type="object"
                                class="oe_highlight"
                                help="Approve the internship request"
                                invisible="state != 'submitted'"
                                groups="internship_management.group_internship_supervisor"/>

                        <button name="action_start" string="Start Internship" type="object"
                                class="oe_highlight"
                                help="Start the approved internship"
                                invisible="state != 'approved'"/>

                        <button name="action_complete" string="Mark Complete" type="object"
                                class="oe_highlight"
                                help="Mark internship as completed"
                                invisible="state != 'in_progress'"/>

                        <button name="action_evaluate" string="Evaluate" type="object"
                                class="oe_highlight"
                                help="Evaluate the completed internship"
                                invisible="state != 'completed'"
                                groups="internship_management.group_internship_supervisor"/>

                        <button name="action_cancel" string="Cancel" type="object"
                                help="Cancel the internship"
                                invisible="state in ['completed', 'evaluated', 'cancelled']"/>

                        <button name="action_reset_to_draft" string="Reset to Draft" type="object"
                                help="Reset internship to draft state"
                                invisible="state != 'cancelled'"
                                groups="internship_management.group_internship_manager"/>
                    </header>

                    <sheet>
                        <div class="oe_button_box" name="button_box">
                            <!-- Smart buttons will be implemented in future versions -->
                        </div>

                        <!-- Title and Reference -->
                        <div class="oe_title">
                            <label for="reference" class="oe_edit_only"/>
                            <h2><field name="reference" readonly="1"/></h2>
                            <label for="name"/>
                            <h1><field name="name" placeholder="Internship title..."/></h1>
                        </div>

                        <!-- Main Information -->
                        <group>
                            <group name="main_info" string="Main Information">
                                <field name="stage_type"/>
                                <field name="company_id"/>
                                <field name="state" invisible="1"/>
                            </group>
                            <group name="participants" string="Participants">
                                <field name="student_id"/>
                                <field name="supervisor_id"/>
                            </group>
                            </group>

                        <!-- Dates and Duration -->
                        <group>
                            <group name="dates" string="Dates">
                                <field name="start_date"/>
                                <field name="end_date"/>
                                <field name="duration" readonly="1"/>
                            </group>
                            <group name="progress_info" string="Progress">
                                <field name="progress" widget="progressbar"/>
                                <field name="grade" readonly="state not in ['completed', 'evaluated']"/>
                                <field name="next_meeting_date"/>
                            </group>
                        </group>

                        <!-- Description and Objectives -->
                        <notebook>
                            <page name="description" string="Description &amp; Objectives">
                                <group>
                                    <group name="description_group" string="Description">
                                        <field name="description" nolabel="1"/>
                                    </group>
                                    <group name="objectives_group" string="Objectives">
                                        <field name="objectives" nolabel="1"/>
                                    </group>
                                </group>
                            </page>

                            <page name="defense" string="Defense">
                                <group>
                                    <group name="defense_info" string="Defense Information">
                                        <field name="defense_status"/>
                                        <field name="defense_date"/>
                                        <field name="defense_room"/>
                                        <field name="defense_duration"/>
                                    </group>
                                    <group name="jury" string="Jury">
                                        <field name="jury_ids" widget="many2many_tags"/>
                                    </group>
                                </group>
                                <group name="notes" string="Evaluation Notes">
                                    <field name="evaluation_notes" nolabel="1"/>
                                </group>
                            </page>

                            <page name="documents" string="Documents">
                                <group>
                                    <group name="auto_documents" string="Auto-generated Documents">
                                        <field name="convention_generated" readonly="1"/>
                                        <field name="attestation_generated" readonly="1"/>
                                    </group>
                                    <group name="document_actions" string="Actions">
                                        <button name="action_generate_convention" string="Generate Convention" type="object"
                                                class="oe_highlight" icon="fa-file-pdf-o"
                                                invisible="convention_generated == True"/>
                                        <button name="action_generate_attestation" string="Generate Attestation" type="object"
                                                class="oe_highlight" icon="fa-file-pdf-o"
                                                invisible="attestation_generated == True or state != 'completed'"/>
                                    </group>
                                </group>
                                <separator string="Related Documents"/>
                                <field name="document_ids" nolabel="1">
                                    <tree>
                                        <field name="name"/>
                                        <field name="document_type"/>
                                        <field name="state"/>
                                        <field name="create_date"/>
                                    </tree>
                                </field>
                            </page>


                            <page name="messages" string="Messages">
                                <field name="message_ids" nolabel="1">
                                    <tree>
                                        <field name="subject"/>
                                        <field name="sender_id"/>
                                        <field name="message_type"/>
                                        <field name="state"/>
                                        <field name="create_date"/>
                                    </tree>
                                </field>
                            </page>

                            <page name="meetings" string="Meetings">
                                <field name="meeting_ids" nolabel="1">
                                    <tree>
                                        <field name="name"/>
                                        <field name="meeting_type"/>
                                        <field name="date"/>
                                        <field name="duration"/>
                                        <field name="state"/>
                                    </tree>
                                </field>
                            </page>

                        </notebook>
                    </sheet>

                    <!-- Chatter -->
                    <div class="oe_chatter">
                        <field name="message_follower_ids"/>
                        <field name="activity_ids"/>
                        <field name="message_ids"/>
                    </div>
                </form>
            </field>
        </record>

        <!-- ================================= -->
        <!-- ACTIONS -->
        <!-- ================================= -->

        <!-- Main action for internships -->
        <record id="action_internship_stage_list" model="ir.actions.act_window">
            <field name="name">Internships</field>
            <field name="res_model">internship.stage</field>
            <field name="view_mode">kanban,tree,form</field>
            <field name="context">{}</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Create your first internship!
                </p>
                <p>
                    Manage all internships in your organization: creation, monitoring, evaluation.
                </p>
            </field>
        </record>

        <!-- Action: My Internships (for students) -->
        <record id="action_internship_stage_my" model="ir.actions.act_window">
            <field name="name">My Internships</field>
            <field name="res_model">internship.stage</field>
            <field name="view_mode">kanban,tree,form</field>
            <field name="domain">[('student_id.user_id', '=', uid)]</field>
            <field name="context">{'default_student_id': uid}</field>
        </record>

        <!-- Action: Internships to Supervise (for supervisors) -->
        <record id="action_internship_stage_supervise" model="ir.actions.act_window">
            <field name="name">Internships to Supervise</field>
            <field name="res_model">internship.stage</field>
            <field name="view_mode">kanban,tree,form</field>
            <field name="domain">[('supervisor_id.user_id', '=', uid)]</field>
        </record>

    </data>
</odoo>