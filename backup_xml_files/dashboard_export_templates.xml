<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <!-- Dashboard Export PDF Report -->
    <record id="report_dashboard_export" model="ir.actions.report">
        <field name="name">Dashboard Export</field>
        <field name="model">internship.stage</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">internship_management.report_dashboard_export</field>
        <field name="report_file">internship_management.report_dashboard_export</field>
        <field name="print_report_name">'Dashboard Export - %s' % (object.name)</field>
        <field name="binding_model_id" ref="model_internship_stage"/>
        <field name="binding_type">report</field>
    </record>

    <!-- Dashboard Export PDF Template -->
    <template id="report_dashboard_export">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="o">
                <t t-call="internship_management.report_dashboard_export_document"/>
            </t>
        </t>
    </template>

    <!-- Dashboard Export Document Template -->
    <template id="report_dashboard_export_document">
        <div class="page">
            <!-- Header -->
            <div class="oe_structure"/>
            <div class="container-fluid">
                <div class="row">
                    <div class="col-12">
                        <h1 class="text-center mb-4">
                            <strong>Internship Management Dashboard Export</strong>
                        </h1>
                        <div class="text-center mb-4">
                            <p class="text-muted">
                                Generated by: <strong t-esc="export_info.get('user', 'Unknown')"/><br/>
                                Role: <strong t-esc="export_info.get('user_role', 'Unknown')"/><br/>
                                Date Range: <strong t-esc="export_info.get('date_range', 'All Time')"/><br/>
                                Export Date: <strong t-esc="export_info.get('export_date', '')"/><br/>
                                Total Records: <strong t-esc="export_info.get('total_records', 0)"/>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Statistics Section -->
                <div class="row mb-4" t-if="statistics.get('role_stats')">
                    <div class="col-12">
                        <h3 class="text-primary">Role-Based Statistics</h3>
                        <div class="table-responsive">
                            <table class="table table-bordered table-striped">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Metric</th>
                                        <th>Value</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr t-foreach="statistics.get('role_stats', {}).items()" t-as="item">
                                        <td><strong t-esc="item[0].replace('_', ' ').title()"/></td>
                                        <td t-esc="item[1]"/>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Internships Section -->
                <div class="row mb-4" t-if="internships">
                    <div class="col-12">
                        <h3 class="text-primary">Internships</h3>
                        <div class="table-responsive">
                            <table class="table table-bordered table-striped">
                                <thead class="table-dark">
                                    <tr>
                                        <th>ID</th>
                                        <th>Name</th>
                                        <th>Student</th>
                                        <th>Supervisor</th>
                                        <th>Company</th>
                                        <th>Type</th>
                                        <th>State</th>
                                        <th>Progress</th>
                                        <th>Grade</th>
                                        <th>Start Date</th>
                                        <th>End Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr t-foreach="internships" t-as="internship">
                                        <td t-esc="internship.get('id', '')"/>
                                        <td t-esc="internship.get('name', '')"/>
                                        <td t-esc="internship.get('student', '')"/>
                                        <td t-esc="internship.get('supervisor', '')"/>
                                        <td t-esc="internship.get('company', '')"/>
                                        <td t-esc="internship.get('stage_type', '')"/>
                                        <td>
                                            <span class="badge" t-attf-class="badge-{internship.get('state', '')}">
                                                <t t-esc="internship.get('state', '')"/>
                                            </span>
                                        </td>
                                        <td>
                                            <div class="progress">
                                                <div class="progress-bar" t-attf-style="width: {internship.get('progress', 0)}%">
                                                    <t t-esc="internship.get('progress', 0)"/>%
                                                </div>
                                            </div>
                                        </td>
                                        <td t-esc="internship.get('grade', 0)"/>
                                        <td t-esc="internship.get('start_date', '')[:10] if internship.get('start_date') else ''"/>
                                        <td t-esc="internship.get('end_date', '')[:10] if internship.get('end_date') else ''"/>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Students Section -->
                <div class="row mb-4" t-if="students">
                    <div class="col-12">
                        <h3 class="text-primary">Students</h3>
                        <div class="table-responsive">
                            <table class="table table-bordered table-striped">
                                <thead class="table-dark">
                                    <tr>
                                        <th>ID</th>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>Specialization</th>
                                        <th>University</th>
                                        <th>Total Internships</th>
                                        <th>Completed</th>
                                        <th>Average Grade</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr t-foreach="students" t-as="student">
                                        <td t-esc="student.get('id', '')"/>
                                        <td t-esc="student.get('name', '')"/>
                                        <td t-esc="student.get('email', '')"/>
                                        <td t-esc="student.get('phone', '')"/>
                                        <td t-esc="student.get('specialization', '')"/>
                                        <td t-esc="student.get('university', '')"/>
                                        <td t-esc="student.get('total_internships', 0)"/>
                                        <td t-esc="student.get('completed_internships', 0)"/>
                                        <td t-esc="student.get('average_grade', 0)"/>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Supervisors Section -->
                <div class="row mb-4" t-if="supervisors">
                    <div class="col-12">
                        <h3 class="text-primary">Supervisors</h3>
                        <div class="table-responsive">
                            <table class="table table-bordered table-striped">
                                <thead class="table-dark">
                                    <tr>
                                        <th>ID</th>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Position</th>
                                        <th>Department</th>
                                        <th>Total Internships</th>
                                        <th>Completion Rate</th>
                                        <th>Average Grade</th>
                                        <th>Current Students</th>
                                        <th>Max Students</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr t-foreach="supervisors" t-as="supervisor">
                                        <td t-esc="supervisor.get('id', '')"/>
                                        <td t-esc="supervisor.get('name', '')"/>
                                        <td t-esc="supervisor.get('email', '')"/>
                                        <td t-esc="supervisor.get('position', '')"/>
                                        <td t-esc="supervisor.get('department', '')"/>
                                        <td t-esc="supervisor.get('total_internships_supervised', 0)"/>
                                        <td t-esc="supervisor.get('successful_completion_rate', 0)"/>%</td>
                                        <td t-esc="supervisor.get('average_student_grade', 0)"/>
                                        <td t-esc="supervisor.get('current_students_count', 0)"/>
                                        <td t-esc="supervisor.get('max_students', 0)"/>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Documents Section -->
                <div class="row mb-4" t-if="documents">
                    <div class="col-12">
                        <h3 class="text-primary">Documents</h3>
                        <div class="table-responsive">
                            <table class="table table-bordered table-striped">
                                <thead class="table-dark">
                                    <tr>
                                        <th>ID</th>
                                        <th>Name</th>
                                        <th>Type</th>
                                        <th>Student</th>
                                        <th>Internship</th>
                                        <th>State</th>
                                        <th>Version</th>
                                        <th>File Size</th>
                                        <th>Downloads</th>
                                        <th>Review Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr t-foreach="documents" t-as="document">
                                        <td t-esc="document.get('id', '')"/>
                                        <td t-esc="document.get('name', '')"/>
                                        <td t-esc="document.get('document_type', '')"/>
                                        <td t-esc="document.get('student', '')"/>
                                        <td t-esc="document.get('internship', '')"/>
                                        <td>
                                            <span class="badge" t-attf-class="badge-{document.get('state', '')}">
                                                <t t-esc="document.get('state', '')"/>
                                            </span>
                                        </td>
                                        <td t-esc="document.get('version_number', '')"/>
                                        <td t-esc="document.get('file_size', '')"/>
                                        <td t-esc="document.get('download_count', 0)"/>
                                        <td t-esc="document.get('review_status', '')"/>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Meetings Section -->
                <div class="row mb-4" t-if="meetings">
                    <div class="col-12">
                        <h3 class="text-primary">Meetings</h3>
                        <div class="table-responsive">
                            <table class="table table-bordered table-striped">
                                <thead class="table-dark">
                                    <tr>
                                        <th>ID</th>
                                        <th>Title</th>
                                        <th>Internship</th>
                                        <th>Student</th>
                                        <th>Supervisor</th>
                                        <th>Type</th>
                                        <th>Date</th>
                                        <th>Duration</th>
                                        <th>State</th>
                                        <th>Location</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr t-foreach="meetings" t-as="meeting">
                                        <td t-esc="meeting.get('id', '')"/>
                                        <td t-esc="meeting.get('title', '')"/>
                                        <td t-esc="meeting.get('internship', '')"/>
                                        <td t-esc="meeting.get('student', '')"/>
                                        <td t-esc="meeting.get('supervisor', '')"/>
                                        <td t-esc="meeting.get('meeting_type', '')"/>
                                        <td t-esc="meeting.get('date', '')[:10] if meeting.get('date') else ''"/>
                                        <td t-esc="meeting.get('duration', 0)"/> min</td>
                                        <td>
                                            <span class="badge" t-attf-class="badge-{meeting.get('state', '')}">
                                                <t t-esc="meeting.get('state', '')"/>
                                            </span>
                                        </td>
                                        <td t-esc="meeting.get('location', '')"/>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Tasks Section -->
                <div class="row mb-4" t-if="tasks">
                    <div class="col-12">
                        <h3 class="text-primary">Tasks</h3>
                        <div class="table-responsive">
                            <table class="table table-bordered table-striped">
                                <thead class="table-dark">
                                    <tr>
                                        <th>ID</th>
                                        <th>Name</th>
                                        <th>Internship</th>
                                        <th>Student</th>
                                        <th>Assigned To</th>
                                        <th>State</th>
                                        <th>Priority</th>
                                        <th>Deadline</th>
                                        <th>Progress</th>
                                        <th>Overdue</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr t-foreach="tasks" t-as="task">
                                        <td t-esc="task.get('id', '')"/>
                                        <td t-esc="task.get('name', '')"/>
                                        <td t-esc="task.get('internship', '')"/>
                                        <td t-esc="task.get('student', '')"/>
                                        <td t-esc="task.get('assigned_to', '')"/>
                                        <td>
                                            <span class="badge" t-attf-class="badge-{task.get('state', '')}">
                                                <t t-esc="task.get('state', '')"/>
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge" t-attf-class="badge-{task.get('priority', '')}">
                                                <t t-esc="task.get('priority', '')"/>
                                            </span>
                                        </td>
                                        <td t-esc="task.get('deadline', '')[:10] if task.get('deadline') else ''"/>
                                        <td>
                                            <div class="progress">
                                                <div class="progress-bar" t-attf-style="width: {task.get('progress_percentage', 0)}%">
                                                    <t t-esc="task.get('progress_percentage', 0)"/>%
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge badge-danger" t-if="task.get('is_overdue')">Yes</span>
                                            <span class="badge badge-success" t-else="">No</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="row mt-5">
                    <div class="col-12">
                        <div class="text-center">
                            <p class="text-muted">
                                <small>
                                    Generated on: <strong t-esc="generated_at"/><br/>
                                    Internship Management System - Professional Export<br/>
                                    TechPal Casablanca
                                </small>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- Export Button in Dashboard -->
    <template id="dashboard_export_buttons" inherit_id="internship_management.dashboard_template">
        <xpath expr="//div[@class='quick-action' and contains(@onclick, 'internship_notification')]" position="after">
            <div class="col-lg-2 col-md-4 col-6 mb-3">
                <div class="quick-action" onclick="exportDashboard('pdf')">
                    <div class="quick-action-icon">
                        <i class="fas fa-file-pdf"></i>
                    </div>
                    <div class="quick-action-label">Export PDF</div>
                </div>
            </div>
            
            <div class="col-lg-2 col-md-4 col-6 mb-3">
                <div class="quick-action" onclick="exportDashboard('excel')">
                    <div class="quick-action-icon">
                        <i class="fas fa-file-excel"></i>
                    </div>
                    <div class="quick-action-label">Export Excel</div>
                </div>
            </div>
            
            <div class="col-lg-2 col-md-4 col-6 mb-3">
                <div class="quick-action" onclick="exportDashboard('csv')">
                    <div class="quick-action-icon">
                        <i class="fas fa-file-csv"></i>
                    </div>
                    <div class="quick-action-label">Export CSV</div>
                </div>
            </div>
        </xpath>
    </template>

    <!-- Export JavaScript Function -->
    <template id="dashboard_export_script" inherit_id="internship_management.dashboard_template">
        <xpath expr="//script" position="inside">
            function exportDashboard(format) {
                const dateRange = document.getElementById('dateRange') ? document.getElementById('dateRange').value : 'month';
                
                // Show loading indicator
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'loading-overlay';
                loadingDiv.innerHTML = `
                    <div class="loading-content">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Generating ${format.toUpperCase()} export...</p>
                    </div>
                `;
                document.body.appendChild(loadingDiv);
                
                // Make export request
                fetch('/internship/dashboard/export', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                    },
                    body: `format=${format}&date_range=${dateRange}`
                })
                .then(response => {
                    if (response.ok) {
                        return response.blob();
                    }
                    throw new Error('Export failed');
                })
                .then(blob => {
                    // Create download link
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `internship_dashboard_${dateRange}_${new Date().toISOString().slice(0,10)}.${format}`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                })
                .catch(error => {
                    console.error('Export error:', error);
                    alert('Export failed. Please try again.');
                })
                .finally(() => {
                    // Remove loading indicator
                    document.body.removeChild(loadingDiv);
                });
            }
            
            // Add loading overlay styles
            const style = document.createElement('style');
            style.textContent = `
                .loading-overlay {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 9999;
                }
                .loading-content {
                    background: white;
                    padding: 2rem;
                    border-radius: 10px;
                    text-align: center;
                }
                .loading-content i {
                    font-size: 2rem;
                    color: #3498db;
                    margin-bottom: 1rem;
                }
            `;
            document.head.appendChild(style);
        </xpath>
    </template>

</odoo>
