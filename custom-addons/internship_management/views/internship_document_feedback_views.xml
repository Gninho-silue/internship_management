<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- Vue Liste (Tree) -->
        <record id="view_internship_document_feedback_tree" model="ir.ui.view">
            <field name="name">internship.document.feedback.tree</field>
            <field name="model">internship.document.feedback</field>
            <field name="arch" type="xml">
                <tree string="Retours sur Documents"
                      decoration-info="status == 'open'"
                      decoration-success="status == 'resolved'"
                      decoration-muted="status == 'dismissed'">
                    <field name="feedback_summary" string="Résumé"/>
                    <field name="document_id" string="Document"/>
                    <field name="reviewer_id" string="Auteur" widget="many2one_avatar_user"/>
                    <field name="feedback_type" string="Type" widget="badge"/>
                    <field name="priority" widget="priority"/>
                    <field name="status" widget="badge"/>
                    <field name="create_date" string="Date"/>
                </tree>
            </field>
        </record>

        <!-- Vue Formulaire -->
        <record id="view_internship_document_feedback_form" model="ir.ui.view">
            <field name="name">internship.document.feedback.form</field>
            <field name="model">internship.document.feedback</field>
            <field name="arch" type="xml">
                <form string="Retour sur Document">
                    <header>
                        <button name="action_resolve" string="Marquer comme Résolu" type="object"
                                class="btn-success" invisible="status != 'open'"
                                groups="internship_management.group_internship_supervisor,
                         internship_management.group_internship_coordinator,internship_management.group_internship_admin"/>
                        <button name="action_dismiss" string="Rejeter" type="object"
                                class="btn-secondary" invisible="status != 'open'"
                                groups="internship_management.group_internship_supervisor,
                         internship_management.group_internship_coordinator,internship_management.group_internship_admin"/>
                        <button name="action_reopen" string="Ré-ouvrir" type="object"
                                class="btn-secondary" invisible="status == 'open'"
                                groups="internship_management.group_internship_supervisor,
                         internship_management.group_internship_coordinator,internship_management.group_internship_admin"/>
                        <field name="status" widget="statusbar"
                               statusbar_visible="open,resolved,dismissed"
                               groups="internship_management.group_internship_supervisor,
                         internship_management.group_internship_coordinator,internship_management.group_internship_admin"/>
                    </header>
                    <sheet>
                        <div class="oe_title">
                            <label for="feedback_summary" string="Résumé du Retour"/>
                            <h1>
                                <field name="feedback_summary" placeholder="Ex: Manque la conclusion..."/>
                            </h1>
                        </div>
                        <group>
                            <group>
                                <field name="document_id" options="{'no_create': True}"/>
                                <field name="stage_id" readonly="1"/>
                                <field name="reviewer_id" readonly="1" widget="many2one_avatar_user"/>
                            </group>
                            <group>
                                <field name="feedback_type"/>
                                <field name="priority" widget="priority"/>
                            </group>
                        </group>

                        <label for="detailed_feedback" string="Détails du Retour"/>
                        <field name="detailed_feedback" nolabel="1"
                               placeholder="Expliquez ici en détail votre commentaire, question ou demande de modification..."/>

                    </sheet>
                    <div class="oe_chatter">
                        <field name="message_follower_ids"/>
                        <field name="activity_ids"/>
                        <field name="message_ids"/>
                    </div>
                </form>
            </field>
        </record>

        <!-- Vue Recherche -->
        <record id="view_internship_document_feedback_search" model="ir.ui.view">
            <field name="name">internship.document.feedback.search</field>
            <field name="model">internship.document.feedback</field>
            <field name="arch" type="xml">
                <search string="Rechercher des Retours">
                    <field name="feedback_summary" string="Résumé"/>
                    <field name="document_id"/>
                    <field name="reviewer_id"/>
                    <field name="stage_id"/>
                    <separator/>
                    <filter string="Ouvert" name="open" domain="[('status', '=', 'open')]"/>
                    <filter string="Résolu" name="resolved" domain="[('status', '=', 'resolved')]"/>
                    <separator/>
                    <filter string="Révision Requise" name="revision"
                            domain="[('feedback_type', '=', 'revision_required')]"/>
                    <filter string="Approbation" name="approval" domain="[('feedback_type', '=', 'approval')]"/>
                    <separator/>
                    <filter string="Mes Retours Émis" name="my_feedback" domain="[('reviewer_id', '=', uid)]"/>
                    <filter string="Feedbacks sur Mes Documents" name="feedback_on_my_documents" 
                            domain="[('document_id.student_id.user_id', '=', uid)]"
                            groups="internship_management.group_internship_student"/>
                    <group expand="0" string="Regrouper par">
                        <filter string="Statut" name="group_status" context="{'group_by': 'status'}"/>
                        <filter string="Type" name="group_type" context="{'group_by': 'feedback_type'}"/>
                        <filter string="Auteur" name="group_reviewer" context="{'group_by': 'reviewer_id'}"/>
                        <filter string="Document" name="group_document" context="{'group_by': 'document_id'}"/>
                    </group>
                </search>
            </field>
        </record>

        <!-- ================================= -->
        <!-- ACTIONS (RÉTABLIES ET TRADUITES) -->
        <!-- ================================= -->
        <record id="action_internship_document_feedback_list" model="ir.actions.act_window">
            <field name="name">Retours sur Documents</field>
            <field name="res_model">internship.document.feedback</field>
            <field name="view_mode">tree,form</field>
            <field name="search_view_id" ref="view_internship_document_feedback_search"/>
            <field name="context">{'search_default_open': 1}</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Aucun retour sur les documents pour l'instant.
                </p>
                <p>
                    Utilisez cette vue pour suivre tous les commentaires et demandes de révision.
                </p>
            </field>
        </record>

        <!-- Action pour "Mes Retours Émis" (pour superviseurs) -->
        <record id="action_internship_document_feedback_my" model="ir.actions.act_window">
            <field name="name">Mes Retours Émis</field>
            <field name="res_model">internship.document.feedback</field>
            <field name="view_mode">tree,form</field>
            <field name="search_view_id" ref="view_internship_document_feedback_search"/>
            <field name="domain">[('reviewer_id', '=', uid)]</field>
            <field name="context">{'search_default_my_feedback': 1}</field>
        </record>

        <!-- Action pour "Feedbacks sur Mes Documents" (pour étudiants) -->
        <record id="action_internship_document_feedback_received" model="ir.actions.act_window">
            <field name="name">Feedbacks sur Mes Documents</field>
            <field name="res_model">internship.document.feedback</field>
            <field name="view_mode">tree,form</field>
            <field name="search_view_id" ref="view_internship_document_feedback_search"/>
            <field name="domain">[('document_id.student_id.user_id', '=', uid)]</field>
            <field name="context">{'search_default_feedback_on_my_documents': 1}</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Aucun feedback reçu pour l'instant !
                </p>
                <p>
                    Les commentaires et retours de vos encadrants sur vos documents apparaîtront ici.
                </p>
            </field>
        </record>

        <!-- Action pour les retours en attente -->
        <record id="action_internship_document_feedback_pending" model="ir.actions.act_window">
            <field name="name">Retours en Attente</field>
            <field name="res_model">internship.document.feedback</field>
            <field name="view_mode">tree,form</field>
            <field name="search_view_id" ref="view_internship_document_feedback_search"/>
            <field name="domain">[('status', '=', 'open')]</field>
            <field name="context">{'search_default_open': 1}</field>
        </record>

    </data>
</odoo>