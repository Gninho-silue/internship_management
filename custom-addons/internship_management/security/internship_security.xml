<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!--
        NOTE D'OPTIMISATION :
        Le paramètre noupdate="0" est généralement utilisé pour les données de démonstration
        ou les données qui peuvent être modifiées par l'utilisateur.
        Pour la sécurité (groupes et règles), il est souvent préférable d'utiliser noupdate="1"
        pour éviter que les mises à jour du module n'écrasent les modifications manuelles faites en production.
        Cependant, en phase de développement, noupdate="0" est acceptable pour pouvoir modifier facilement
        les règles. Je le laisse à "0" selon votre fichier original.
    -->
    <data noupdate="0">

        <!-- Catégorie de Sécurité -->
        <record id="module_category_internship" model="ir.module.category">
            <field name="name">Gestion des Stages</field>
            <field name="description">Système complet de gestion des stages et des étudiants.</field>
            <field name="sequence">10</field>
        </record>

        <!-- =============================================== -->
        <!-- GROUPES DE SÉCURITÉ -->
        <!-- =============================================== -->

        <record id="group_internship_student" model="res.groups">
            <field name="name">Étudiant / Stagiaire</field>
            <field name="category_id" ref="module_category_internship"/>
            <field name="comment">Accès en lecture/écriture à ses propres stages et documents.</field>
        </record>

        <record id="group_internship_supervisor" model="res.groups">
            <field name="name">Encadrant</field>
            <field name="category_id" ref="module_category_internship"/>
            <field name="comment">Gérer les étudiants assignés et valider les étapes des stages.</field>
        </record>

        <record id="group_internship_coordinator" model="res.groups">
            <field name="name">Coordinateur de Stages</field>
            <field name="category_id" ref="module_category_internship"/>
            <field name="comment">Coordination générale des stages, assignations et supervision globale.</field>
        </record>

        <!-- NOTE: Le groupe admin n'est pas toujours nécessaire si on hérite du groupe 'base.group_system' -->
        <record id="group_internship_admin" model="res.groups">
            <field name="name">Administrateur de la Gestion des Stages</field>
            <field name="category_id" ref="module_category_internship"/>
            <field name="comment">Accès complet à tous les modules de gestion des stages.</field>
            <!-- OPTIMISATION: Un administrateur devrait aussi être coordinateur pour hériter de ses droits -->
            <field name="implied_ids" eval="[(4, ref('group_internship_coordinator'))]"/>
        </record>

        <!-- =============================================== -->
        <!-- RÈGLES D'ENREGISTREMENT (POLITIQUES DE SÉCURITÉ) -->
        <!-- =============================================== -->

        <!-- Règles pour le modèle Étudiant (internship.student) -->
        <record id="internship_student_rule_own" model="ir.rule">
            <field name="name">Étudiants: Données personnelles uniquement</field>
            <field name="model_id" ref="model_internship_student"/>
            <field name="domain_force">[('user_id', '=', user.id)]</field>
            <field name="groups" eval="[(4, ref('group_internship_student'))]"/>
        </record>

        <record id="internship_student_rule_supervisor" model="ir.rule">
            <field name="name">Étudiants: L'encadrant voit ses étudiants assignés</field>
            <field name="model_id" ref="model_internship_student"/>
            <field name="domain_force">[('internship_ids.supervisor_id.user_id', '=', user.id)]</field>
            <field name="groups" eval="[(4, ref('group_internship_supervisor'))]"/>
        </record>

        <!-- Règles pour le modèle Stage (internship.stage) -->
        <record id="internship_stage_rule_student" model="ir.rule">
            <field name="name">Stages: L'étudiant voit ses propres stages</field>
            <field name="model_id" ref="model_internship_stage"/>
            <field name="domain_force">[('student_id.user_id', '=', user.id)]</field>
            <field name="groups" eval="[(4, ref('group_internship_student'))]"/>
        </record>

        <record id="internship_stage_rule_supervisor" model="ir.rule">
            <field name="name">Stages: L'encadrant voit les stages qui lui sont assignés</field>
            <field name="model_id" ref="model_internship_stage"/>
            <field name="domain_force">[('supervisor_id.user_id', '=', user.id)]</field>
            <field name="groups" eval="[(4, ref('group_internship_supervisor'))]"/>
        </record>

        <!-- Règles pour le modèle Document (internship.document) -->
        <record id="internship_document_rule_student" model="ir.rule">
            <field name="name">Documents: L'étudiant voit ses propres documents</field>
            <field name="model_id" ref="model_internship_document"/>
            <field name="domain_force">[('stage_id.student_id.user_id', '=', user.id)]</field>
            <field name="groups" eval="[(4, ref('group_internship_student'))]"/>
        </record>

        <record id="internship_document_rule_supervisor" model="ir.rule">
            <field name="name">Documents: L'encadrant voit les documents de ses stages</field>
            <field name="model_id" ref="model_internship_document"/>
            <field name="domain_force">[('stage_id.supervisor_id.user_id', '=', user.id)]</field>
            <field name="groups" eval="[(4, ref('group_internship_supervisor'))]"/>
        </record>

        <!-- Règles pour le modèle Réunion (internship.meeting) - CORRIGÉES -->
        <record id="internship_meeting_rule_participants" model="ir.rule">
            <field name="name">Réunions: Les participants et l'organisateur voient la réunion</field>
            <field name="model_id" ref="model_internship_meeting"/>
            <!--
                CORRECTION ET OPTIMISATION :
                1. Renommage de 'participant_ids' en 'partner_ids'.
                2. Utilisation de 'user.partner_id.id' pour la comparaison, car le champ pointe vers res.partner.
                3. Fusion des deux règles (étudiant et encadrant) en une seule pour les participants,
                   car leur logique était identique. C'est plus propre et facile à maintenir.
            -->
            <field name="domain_force">['|',
                ('organizer_id', '=', user.id),
                ('partner_ids', 'in', [user.partner_id.id])]
            </field>
            <field name="groups"
                   eval="[(4, ref('group_internship_student')), (4, ref('group_internship_supervisor'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="True"/>
            <field name="perm_create" eval="True"/>
            <field name="perm_unlink" eval="False"/>
        </record>

        <!-- Règles pour le modèle Encadrant (internship.supervisor) -->
        <record id="internship_supervisor_rule_own" model="ir.rule">
            <field name="name">Encadrants: Accès à leur propre profil</field>
            <field name="model_id" ref="model_internship_supervisor"/>
            <field name="domain_force">[('user_id', '=', user.id)]</field>
            <field name="groups" eval="[(4, ref('group_internship_supervisor'))]"/>
        </record>

        <!-- ============================================================== -->
        <!-- RÈGLES GLOBALES POUR COORDINATEURS ET ADMINS (ACCÈS TOTAL) -->
        <!-- ============================================================== -->
        <!-- NOTE: Une seule règle globale par modèle est plus simple à gérer. -->

        <record id="internship_global_rule_coordinator" model="ir.rule">
            <field name="name">Accès global pour les coordinateurs</field>
            <field name="model_id" ref="model_internship_stage"/>
            <field name="domain_force">[(1, '=', 1)]</field>
            <field name="groups" eval="[(4, ref('group_internship_coordinator'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="True"/>
            <field name="perm_create" eval="True"/>
            <field name="perm_unlink" eval="True"/>
        </record>

        <record id="internship_student_rule_coordinator" model="ir.rule">
            <field name="name">Accès global aux étudiants pour les coordinateurs</field>
            <field name="model_id" ref="model_internship_student"/>
            <field name="domain_force">[(1, '=', 1)]</field>
            <field name="groups" eval="[(4, ref('group_internship_coordinator'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="True"/>
            <field name="perm_create" eval="True"/>
            <field name="perm_unlink" eval="True"/>
        </record>

        <record id="internship_supervisor_rule_coordinator" model="ir.rule">
            <field name="name">Accès global aux encadrants pour les coordinateurs</field>
            <field name="model_id" ref="model_internship_supervisor"/>
            <field name="domain_force">[(1, '=', 1)]</field>
            <field name="groups" eval="[(4, ref('group_internship_coordinator'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="True"/>
            <field name="perm_create" eval="True"/>
            <field name="perm_unlink" eval="True"/>
        </record>

        <record id="internship_document_rule_coordinator" model="ir.rule">
            <field name="name">Accès global aux documents pour les coordinateurs</field>
            <field name="model_id" ref="model_internship_document"/>
            <field name="domain_force">[(1, '=', 1)]</field>
            <field name="groups" eval="[(4, ref('group_internship_coordinator'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="True"/>
            <field name="perm_create" eval="True"/>
            <field name="perm_unlink" eval="True"/>
        </record>

        <record id="internship_meeting_rule_coordinator" model="ir.rule">
            <field name="name">Accès global aux réunions pour les coordinateurs</field>
            <field name="model_id" ref="model_internship_meeting"/>
            <field name="domain_force">[(1, '=', 1)]</field>
            <field name="groups" eval="[(4, ref('group_internship_coordinator'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="True"/>
            <field name="perm_create" eval="True"/>
            <field name="perm_unlink" eval="True"/>
        </record>

        <!-- Règles pour les Tâches (internship.todo) -->
        <record id="rule_internship_todo_participants" model="ir.rule">
            <field name="name">Tâches: L'assigné et les membres du stage peuvent voir les tâches</field>
            <field name="model_id" ref="model_internship_todo"/>
            <field name="domain_force">[
                '|',
                ('assigned_to.user_id', '=', user.id),
                '|',
                ('stage_id.student_id.user_id', '=', user.id),
                ('stage_id.supervisor_id.user_id', '=', user.id)
                ]
            </field>
            <field name="groups"
                   eval="[(4, ref('group_internship_student')), (4, ref('group_internship_supervisor'))]"/>
        </record>

        <record id="rule_internship_todo_coordinator" model="ir.rule">
            <field name="name">Tâches: Accès global pour les coordinateurs</field>
            <field name="model_id" ref="model_internship_todo"/>
            <field name="domain_force">[(1, '=', 1)]</field>
            <field name="groups" eval="[(4, ref('group_internship_coordinator'))]"/>
        </record>

        <!-- Règles pour les Présentations (internship.presentation) -->
        <record id="internship_presentation_rule_student" model="ir.rule">
            <field name="name">Présentations: L'étudiant voit ses propres présentations</field>
            <field name="model_id" ref="model_internship_presentation"/>
            <field name="domain_force">[('student_id.user_id', '=', user.id)]</field>
            <field name="groups" eval="[(4, ref('group_internship_student'))]"/>
        </record>

        <record id="internship_presentation_rule_supervisor" model="ir.rule">
            <field name="name">Présentations: L'encadrant voit les présentations de ses étudiants</field>
            <field name="model_id" ref="model_internship_presentation"/>
            <!-- OPTIMISATION: Le domaine peut être plus direct -->
            <field name="domain_force">[('stage_id.supervisor_id.user_id', '=', user.id)]</field>
            <field name="groups" eval="[(4, ref('group_internship_supervisor'))]"/>
        </record>

        <record id="internship_presentation_rule_coordinator" model="ir.rule">
            <field name="name">Présentations: Accès global pour les coordinateurs</field>
            <field name="model_id" ref="model_internship_presentation"/>
            <field name="domain_force">[(1, '=', 1)]</field>
            <field name="groups" eval="[(4, ref('group_internship_coordinator'))]"/>
        </record>
    </data>
</odoo>